
# 🎯 Unreal Engine 行为树与 Decorator 中止机制全总结

> 本文总结了行为树中有关 **Decorator 中止（Abort）机制** 的所有关键点，适用于设计复杂 AI 行为逻辑的开发者。

---

## 🧠 1. Decorator 的本质作用

- **不带 Abort**：只在首次评估节点时判断一次（类似门卫），之后不再理会条件是否变化。
- **带 Abort**：持续监听绑定的黑板键，只要值/结果发生变化就能触发中止行为。

---

## 🧨 2. Abort 类型说明

| 类型           | 说明 |
|----------------|------|
| `None`         | 不监听，条件只在初次评估时有效。 |
| `Self`         | 仅中止**自己这个节点**。用于重新评估是否还能执行自己。 |
| `Lower Priority` | 中止**右边的兄弟节点**，自身重新尝试评估（常用于高优先级行为打断低优先级行为）。 |
| `Both`         | 同时中止自己和右边兄弟节点，一般用于更强的优先级控制。 |

---

## 🎯 3. `值改变时` vs `结果改变时`

- **值改变时（Value Change）**：
  - 黑板键的值发生任何改变就会触发 Abort（即使判断结果没变）。
  - 更灵敏、可能造成频繁中止。
- **结果改变时（Result Change）**：
  - 只有当 Decorator 条件的**真假发生变化**时才触发 Abort。
  - 推荐用在大多数情况下，更稳定、更可控。

> ✅ 实际开发中，**建议默认使用“结果改变时”**，除非你确实需要对所有值变动都做出响应。

---

## 📊 4. Abort 与行为优先级设计

### 敌人行为设计建议：

假设你有以下需求：

- 敌人看到玩家 → 攻击
- 没看到 → 巡逻
- 血量低 → 回血
- 远程敌人优先用远程攻击，近战优先近战

### 推荐行为树结构：

```
Selector (根)
├── 战斗 Selector
│   ├── 回血（Decorator: HP < X，Abort: LowerPriority）
│   └── 攻击 Selector
│       ├── 远程攻击（远程敌人进入距离范围）
│       └── 近战攻击（近战敌人接近目标）
└── 巡逻
```

- 使用 `Abort: LowerPriority` 持续监听回血条件，一旦满足立刻打断战斗或巡逻。
- 攻击内部再细分远程与近战。
- 移动行为应包含在每个攻击节点内部（例如远程靠近射程、近战追击敌人）。

---

## 🧩 5. 多个 Abort 重叠的处理方式

- Unreal 会**从上到下依次判断**。
- 每个装饰器都可以有自己的黑板监听项和触发逻辑。
- 若多个节点都能触发中止行为，**最上层的父节点决定最终评估顺序**。

---

## 🔁 6. Abort 中止后行为树的重新评估方式

| 父节点类型   | 中止后行为 |
|--------------|------------|
| **Selector** | 从最左子节点开始尝试评估，直到遇到一个成功节点。 |
| **Sequence** | 从最左子节点开始评估，直到遇到一个失败节点。 |
| **Parallel** | 特殊处理方式，依赖其 Finish/Fail 策略。 |

即：
> **无论 Selector 还是 Sequence，Abort 触发后都会从该父节点的最左侧子节点重新开始评估。**

---

## 💡 7. 是否所有重新进入的节点都会重新执行？

是的！只要节点因为 Abort 被中止 → 它的父节点重新评估时会**重新执行**之前已经成功的节点，除非你自己实现了缓存或跳过。

---

## 🎯 8. 关于 Decorator 的误区澄清

### Q: 黑板值变化时节点已不能执行，不也不会继续了吗？

A: 如果没加 Abort，就不会中止，只是下次轮到它才会发现条件不满足了。

所以：

> 加了 Abort 才是“**监听+打断**”，没加的话就只是“**判断一次**”。

---

## ✅ 9. 一句话总结行为树中止机制

> **Decorator 是条件评估器，加上 Abort 就成为“实时监听器”，控制行为中止与优先级抢占。**
